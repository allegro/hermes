package pl.allegro.tech.hermes.management.infrastructure.prometheus

import com.github.tomakehurst.wiremock.client.WireMock
import com.github.tomakehurst.wiremock.junit.WireMockRule
import jakarta.ws.rs.core.MediaType
import org.junit.Rule
import org.springframework.web.client.RestTemplate
import pl.allegro.tech.hermes.management.infrastructure.metrics.MonitoringMetricsContainer
import pl.allegro.tech.hermes.test.helper.util.Ports
import spock.lang.Specification

import java.nio.charset.StandardCharsets

import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo
import static com.github.tomakehurst.wiremock.core.WireMockConfiguration.wireMockConfig
import static pl.allegro.tech.hermes.api.MetricDecimalValue.of

class RestTemplatePrometheusClientTest extends Specification {

    private static final int PROMETHEUS_HTTP_PORT = Ports.nextAvailable()
    private static final String query = "sum by (__name__,group,topic,subscription,status_code)" +
            "(irate({__name__=~'hermes_consumers_subscription_delivered_total" +
            "|hermes_consumers_subscription_timeouts_total" +
            "|hermes_consumers_subscription_retries_total" +
            "|hermes_consumers_subscription_throughput_bytes_total" +
            "|hermes_consumers_subscription_other_errors_total" +
            "|hermes_consumers_subscription_batches_total" +
            "|hermes_consumers_subscription_http_status_codes_total'," +
            "group='pl.allegro.tech.hermes',topic='Monitor',subscription='consumer1'}[1m]) keep_metric_names)"

    @Rule
    WireMockRule wireMockRule = new WireMockRule(
            wireMockConfig().port(PROMETHEUS_HTTP_PORT).usingFilesUnderClasspath("prometheus-stubs"))

    private RestTemplatePrometheusClient client

    void setup() {
        RestTemplate restTemplate = new RestTemplate()
        client = new RestTemplatePrometheusClient(restTemplate, URI.create("http://localhost:$PROMETHEUS_HTTP_PORT"))
    }

    def "should get metrics for path"() {
        given:
        mockPrometheus(query, "full_response.json")

        when:
        MonitoringMetricsContainer metrics = client.readMetrics(query)

        then:
        metrics.metricValue("hermes_consumers_subscription_delivered_total") == of("1.0")
        metrics.metricValue("hermes_consumers_subscription_timeouts_total") == of("2.0")
        metrics.metricValue("hermes_consumers_subscription_retries_total") == of("1.0")
        metrics.metricValue("hermes_consumers_subscription_throughput_bytes_total") == of("3.0")
        metrics.metricValue("hermes_consumers_subscription_other_errors_total") == of("4.0")
        metrics.metricValue("hermes_consumers_subscription_batches_total") == of("5.0")
        metrics.metricValue("hermes_consumers_subscription_http_status_codes_total_2xx") == of("2.0")
        metrics.metricValue("hermes_consumers_subscription_http_status_codes_total_4xx") == of("1.0")
        metrics.metricValue("hermes_consumers_subscription_http_status_codes_total_5xx") == of("2.0")
    }

    def "should return default value when metric has no value"() {
        given:
        mockPrometheus(query, "partial_response.json")

        when:
        MonitoringMetricsContainer metrics = client.readMetrics(query)

        then:
        metrics.metricValue("hermes_consumers_subscription_delivered_total") == of("0.0")
        metrics.metricValue("hermes_consumers_subscription_timeouts_total") == of("2.0")
        metrics.metricValue("hermes_consumers_subscription_retries_total") == of("1.0")
        metrics.metricValue("hermes_consumers_subscription_throughput_bytes_total") == of("3.0")
        metrics.metricValue("hermes_consumers_subscription_other_errors_total") == of("4.0")
        metrics.metricValue("hermes_consumers_subscription_batches_total") == of("5.0")
        metrics.metricValue("hermes_consumers_subscription_http_status_codes_total_2xx") == of("2.0")
        metrics.metricValue("hermes_consumers_subscription_http_status_codes_total_4xx") == of("1.0")
        metrics.metricValue("hermes_consumers_subscription_http_status_codes_total_5xx") == of("0.0")
    }

    private void mockPrometheus(String query, String responseFile) {
        String encodedQuery = URLEncoder.encode(query, StandardCharsets.UTF_8)
        WireMock.stubFor(WireMock.get(urlEqualTo(String.format("/api/v1/query?query=%s", encodedQuery)))
                .willReturn(WireMock.aResponse()
                        .withStatus(200)
                        .withHeader("Content-Type", MediaType.APPLICATION_JSON)
                        .withBodyFile(responseFile)))
    }
}
